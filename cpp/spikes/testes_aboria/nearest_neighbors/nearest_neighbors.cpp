#include "Aboria.h"

#include <vector>
#include <iostream>

using namespace Aboria;

// g++ -Wall -O3 -std=c++14 -I../Aboria/src -I../Aboria/third-party nearest_neighbors.cpp -o nearest_neighbors

int main() {

	std::vector<std::vector<double>> points = {
		{0.00000000, 0.00000000, 0.00000000},
		{0.00000000, 1.47377633, 2.08423447},
		{0.00000000, 2.94755266, 4.16846894},
		{1.27632774, 0.73688816, 4.16846894},
		{1.27632774, 2.21066449, -0.00000000},
		{1.27632774, 3.68444082, 2.08423447},
		{2.55265548, -0.00000000, -0.00000000},
		{2.55265548, 1.47377633, 2.08423447},
		{2.55265548, 2.94755266, 4.16846894},
		{3.82898322, 0.73688816, 4.16846894},
		{3.82898322, 2.21066449, -0.00000000},
		{3.82898322, 3.68444082, 2.08423447},
		{0.00000000, 4.42132899, 0.00000000},
		{0.00000000, 5.89510531, 2.08423447},
		{0.00000000, 7.36888164, 4.16846894},
		{1.27632774, 5.15821715, 4.16846894},
		{1.27632774, 6.63199348, -0.00000000},
		{1.27632774, 8.10576981, 2.08423447},
		{2.55265548, 4.42132899, -0.00000000},
		{2.55265548, 5.89510531, 2.08423447},
		{2.55265548, 7.36888164, 4.16846894},
		{3.82898322, 5.15821715, 4.16846894},
		{3.82898322, 6.63199348, -0.00000000},
		{3.82898322, 8.10576981, 2.08423447},
		{0.00000000, 0.00000000, 6.25270342},
		{0.00000000, 1.47377633, 8.33693789},
		{0.00000000, 2.94755266, 10.42117236},
		{1.27632774, 0.73688816, 10.42117236},
		{1.27632774, 2.21066449, 6.25270342},
		{1.27632774, 3.68444082, 8.33693789},
		{2.55265548, 0.00000000, 6.25270342},
		{2.55265548, 1.47377633, 8.33693789},
		{2.55265548, 2.94755266, 10.42117236},
		{3.82898322, 0.73688816, 10.42117236},
		{3.82898322, 2.21066449, 6.25270342},
		{3.82898322, 3.68444082, 8.33693789},
		{0.00000000, 4.42132899, 6.25270342},
		{0.00000000, 5.89510531, 8.33693789},
		{0.00000000, 7.36888164, 10.42117236},
		{1.27632774, 5.15821715, 10.42117236},
		{1.27632774, 6.63199348, 6.25270342},
		{1.27632774, 8.10576981, 8.33693789},
		{2.55265548, 4.42132899, 6.25270342},
		{2.55265548, 5.89510531, 8.33693789},
		{2.55265548, 7.36888164, 10.42117236},
		{3.82898322, 5.15821715, 10.42117236},
		{3.82898322, 6.63199348, 6.25270342},
		{3.82898322, 8.10576981, 8.33693789}
	};

	//ABORIA_VARIABLE(neighbours_count, int, "number of neighbours")

	//typedef Particles<std::tuple<neighbours_count>> particle_t;
	typedef Particles<std::tuple<>, 3, std::vector, CellListOrdered> particle_t;
	typedef particle_t::position position;

	const size_t N = points.size();
	particle_t particles(N);
	for (size_t i = 0; i < N; ++i) {
		get<position>(particles)[i] = vdouble3(points[i][0], points[i][1], points[i][2]);
	}

	vdouble3 min = vdouble3(0, 0, 0);
	vdouble3 max = vdouble3(3.83, 8.11, 10.43);
	//vbool3 periodic = vbool3::Constant(true);
	vbool3 periodic = vbool3(true, true, false);
	particles.init_neighbour_search(min, max, periodic);

	double radius = 3;
	int count = 0;
	for (auto i = euclidean_search(particles.get_query(), vdouble3::Constant(0), radius); i != false; ++i) {
		count++;

		std::cout << "Found a particle with dx = " << i.dx() << " and id = " << get<id>(*i) << "\n";
	}

	std::cout << "There are " << count << " particles.\n";

	return 0;
}
